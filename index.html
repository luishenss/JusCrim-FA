<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JusCrim-FA â€” AnÃ¡lise de Antecedentes</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg:           #f1f5f9;
      --surface:      #ffffff;
      --surface-2:    #f8fafc;
      --border:       #e2e8f0;
      --primary:      #4f46e5;
      --primary-h:    #4338ca;
      --primary-bg:   #eef2ff;
      --text:         #0f172a;
      --text-2:       #475569;
      --text-3:       #94a3b8;
      --green:        #059669;
      --green-bg:     #ecfdf5;
      --green-border: #a7f3d0;
      --red:          #dc2626;
      --red-bg:       #fef2f2;
      --amber-bg:     #fffbeb;
      --amber:        #b45309;
      --radius:       12px;
      --shadow:       0 1px 3px rgba(0,0,0,.07), 0 1px 2px rgba(0,0,0,.04);
      --shadow-md:    0 4px 6px -1px rgba(0,0,0,.07), 0 2px 4px -2px rgba(0,0,0,.04);
      --shadow-lg:    0 10px 25px -5px rgba(0,0,0,.1), 0 4px 6px -4px rgba(0,0,0,.04);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 40px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      width: 38px; height: 38px;
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-size: 19px;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(79,70,229,.3);
    }

    .brand-name {
      font-size: 1rem;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -.01em;
    }

    .brand-sub {
      font-size: 0.7rem;
      color: var(--text-3);
      font-weight: 400;
      margin-top: 1px;
    }

    .header-actions { display: flex; align-items: center; gap: 8px; }

    .pill {
      background: var(--primary-bg);
      color: var(--primary);
      font-size: 0.68rem;
      font-weight: 700;
      padding: 3px 9px;
      border-radius: 20px;
      letter-spacing: .02em;
    }

    .pill-red {
      background: var(--red-bg);
      color: var(--red);
    }

    .user-pill {
      background: var(--surface-2);
      color: var(--text-2);
      border: 1px solid var(--border);
    }

    .icon-btn {
      width: 36px; height: 36px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text-2);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px;
      transition: all .15s;
      flex-shrink: 0;
    }
    .icon-btn:hover { background: var(--surface-2); color: var(--text); border-color: #c7d2e0; }

    .lock-badge {
      display: flex; align-items: center; gap: 5px;
      font-size: 0.68rem; font-weight: 700; padding: 3px 9px;
      border-radius: 20px; letter-spacing: .02em; cursor: default;
    }
    .lock-badge.locked   { background: #fef2f2; color: var(--red); }
    .lock-badge.unlocked { background: var(--green-bg); color: var(--green); }

    /* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      max-width: 680px;
      margin: 0 auto;
      padding: 40px 24px 100px;
    }

    /* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px 28px 24px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    .section-label {
      font-size: 0.68rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--text-3);
      margin-bottom: 18px;
    }

    /* â”€â”€ FORM INPUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .field { margin-bottom: 20px; }

    .field label {
      display: block;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-2);
      margin-bottom: 7px;
    }

    input[type="date"] {
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 0.92rem;
      color: var(--text);
      background: var(--surface);
      outline: none;
      transition: border-color .15s, box-shadow .15s;
      font-family: inherit;
    }
    input[type="date"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79,70,229,.1);
    }

    /* â”€â”€ DROPZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dropzone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 36px 24px;
      text-align: center;
      cursor: pointer;
      transition: all .2s;
      position: relative;
      background: var(--surface-2);
    }
    .dropzone:hover, .dropzone.drag-over {
      border-color: var(--primary);
      background: var(--primary-bg);
    }
    .dropzone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    .dz-icon { font-size: 2.2rem; margin-bottom: 10px; line-height: 1; }
    .dz-title { font-size: 0.9rem; font-weight: 600; color: var(--text); margin-bottom: 4px; }
    .dz-sub   { font-size: 0.77rem; color: var(--text-3); }

    /* â”€â”€ FILE ATTACHED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .file-chip {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--green-bg);
      border: 1.5px solid var(--green-border);
      border-radius: 8px;
    }
    .file-chip-icon { font-size: 1.35rem; flex-shrink: 0; }
    .file-chip-info { flex: 1; min-width: 0; }
    .file-chip-name {
      font-size: 0.83rem;
      font-weight: 600;
      color: #065f46;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-chip-size { font-size: 0.73rem; color: var(--green); margin-top: 1px; }
    .file-chip-remove {
      background: none; border: none;
      color: var(--green); cursor: pointer;
      font-size: 1rem; padding: 4px; border-radius: 4px;
      transition: color .15s; flex-shrink: 0;
    }
    .file-chip-remove:hover { color: var(--red); }

    /* â”€â”€ ANALYZE BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-analyze {
      width: 100%;
      padding: 13px;
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 0.92rem;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      margin-top: 8px;
      box-shadow: 0 4px 14px rgba(79,70,229,.28);
      letter-spacing: .01em;
      font-family: inherit;
    }
    .btn-analyze:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(79,70,229,.36);
    }
    .btn-analyze:active:not(:disabled) { transform: translateY(0); }
    .btn-analyze:disabled { opacity: .45; cursor: not-allowed; box-shadow: none; }

    /* â”€â”€ NOTICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .notice {
      display: flex;
      gap: 9px;
      align-items: flex-start;
      padding: 11px 14px;
      border-radius: 8px;
      font-size: 0.78rem;
      line-height: 1.55;
      margin-top: 16px;
    }
    .notice-warn { background: var(--amber-bg); color: var(--amber); border: 1px solid #fcd34d; }
    .notice-icon { flex-shrink: 0; margin-top: 1px; }

    /* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .loading-wrap {
      text-align: center;
      padding: 52px 28px;
    }
    .spinner {
      width: 44px; height: 44px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin .75s linear infinite;
      margin: 0 auto 18px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-title { font-size: 0.95rem; font-weight: 600; color: var(--text); margin-bottom: 5px; }
    .loading-sub   { font-size: 0.8rem; color: var(--text-3); }

    /* â”€â”€ RESULT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .result-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 22px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .badge-ok {
      display: flex; align-items: center; gap: 6px;
      background: var(--green-bg);
      color: var(--green);
      border: 1px solid var(--green-border);
      font-size: 0.73rem;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 20px;
    }

    .result-actions { display: flex; gap: 8px; }

    .btn-sm {
      padding: 7px 14px;
      border: 1.5px solid var(--border);
      border-radius: 7px;
      background: var(--surface);
      color: var(--text-2);
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .15s;
      display: flex; align-items: center; gap: 6px;
      font-family: inherit;
    }
    .btn-sm:hover { background: var(--surface-2); color: var(--text); }
    .btn-sm.pri {
      background: var(--primary); border-color: var(--primary); color: #fff;
    }
    .btn-sm.pri:hover { background: var(--primary-h); border-color: var(--primary-h); }

    /* â”€â”€ MARKDOWN RESULT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .md {
      font-size: 0.875rem;
      line-height: 1.75;
      color: var(--text);
    }
    .md h1 { font-size: 1.1rem; margin: 24px 0 10px; color: var(--text); }
    .md h2 { font-size: 1rem; margin: 20px 0 8px; color: var(--text); }
    .md h3 {
      font-size: 0.875rem; margin: 18px 0 6px;
      color: var(--primary); font-weight: 700;
    }
    .md p { margin-bottom: 10px; }
    .md ul, .md ol { padding-left: 22px; margin-bottom: 10px; }
    .md li { margin-bottom: 4px; }
    .md strong { font-weight: 700; }
    .md em { font-style: italic; }
    .md hr { border: none; border-top: 1px solid var(--border); margin: 22px 0; }
    .md blockquote {
      border-left: 3px solid var(--primary);
      padding-left: 14px;
      color: var(--text-2);
      margin: 10px 0;
      font-style: italic;
    }
    .md code {
      background: var(--surface-2);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.82em;
      font-family: 'Courier New', monospace;
      color: var(--primary);
    }
    .md table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      font-size: 0.8rem;
    }
    .md th {
      background: var(--surface-2);
      padding: 9px 12px;
      text-align: left;
      font-weight: 700;
      border: 1px solid var(--border);
      color: var(--text-2);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    .md td {
      padding: 8px 12px;
      border: 1px solid var(--border);
      vertical-align: top;
    }
    .md tr:nth-child(even) td { background: #fafafa; }

    /* streaming cursor */
    .cursor {
      display: inline-block;
      width: 2px; height: 1em;
      background: var(--primary);
      animation: blink .65s step-end infinite;
      vertical-align: text-bottom;
      margin-left: 2px;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(15,23,42,.45);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: flex; align-items: center; justify-content: center;
      padding: 24px;
    }
    .overlay.hidden { display: none; }

    .modal {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 32px;
      width: 100%; max-width: 420px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }
    .modal-icon { font-size: 1.8rem; margin-bottom: 12px; }
    .modal h2 { font-size: 1.1rem; font-weight: 800; margin-bottom: 8px; }
    .modal .desc {
      font-size: 0.81rem; color: var(--text-2); line-height: 1.55;
      margin-bottom: 20px;
    }
    .modal .desc a { color: var(--primary); text-decoration: none; }
    .modal .desc a:hover { text-decoration: underline; }

    .modal-label {
      font-size: .78rem; font-weight: 600; color: var(--text-2);
      display: block; margin-bottom: 6px;
    }
    .modal-label-note {
      font-weight: 400; color: var(--text-3);
    }

    .input-wrap { position: relative; margin-bottom: 16px; }
    .input-wrap input {
      width: 100%;
      padding: 10px 38px 10px 14px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 0.88rem;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
      font-family: inherit;
      color: var(--text);
    }
    .input-wrap input.mono { font-family: monospace; }
    .input-wrap input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79,70,229,.1);
    }
    .toggle-pw {
      position: absolute; right: 10px; top: 50%;
      transform: translateY(-50%);
      background: none; border: none; cursor: pointer;
      color: var(--text-3); font-size: 0.85rem;
      padding: 2px 4px;
    }
    .toggle-pw:hover { color: var(--text-2); }

    .modal-footer {
      display: flex; gap: 8px; justify-content: flex-end; margin-top: 4px;
    }

    /* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 10px 40px;
      font-size: 0.7rem;
      color: var(--text-3);
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 -1px 0 var(--border);
    }
    footer a { color: var(--text-3); text-decoration: none; }
    footer a:hover { color: var(--text-2); }

    .hidden { display: none !important; }

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed; bottom: 60px; right: 24px; z-index: 999;
      background: #0f172a; color: #e2e8f0;
      padding: 10px 18px;
      border-radius: 8px; font-size: 0.82rem; font-weight: 600;
      box-shadow: var(--shadow-lg);
      opacity: 0; transform: translateY(8px);
      transition: all .25s; pointer-events: none;
    }
    #toast.show { opacity: 1; transform: translateY(0); }

    @media (max-width: 600px) {
      main   { padding: 24px 16px 90px; }
      header { padding: 0 20px; }
      footer { padding: 10px 20px; font-size: 0.65rem; }
    }
  </style>
</head>
<body>

<!-- â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="header-brand">
    <div class="brand-icon">âš–ï¸</div>
    <div>
      <div class="brand-name">JusCrim-FA</div>
      <div class="brand-sub">AnÃ¡lise de Antecedentes Criminais Â· TJSP</div>
    </div>
  </div>
  <div class="header-actions">
    <span class="pill">v3.4</span>
    <span class="pill pill-red">Uso Judicial</span>
    <span class="lock-badge locked" id="lockBadge" title="Estado da sessÃ£o">ğŸ”’ Bloqueado</span>
    <span class="pill user-pill hidden" id="userBadge" title="UsuÃ¡rio autenticado">ğŸ‘¤ <span id="userLabel"></span></span>
    <button class="icon-btn hidden" id="btnLogout" title="Encerrar sessÃ£o">ğŸšª</button>
    <button class="icon-btn hidden" id="btnSettings" title="ConfiguraÃ§Ãµes (admin)">âš™ï¸</button>
  </div>
</header>

<!-- â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main>

  <!-- FORM -->
  <div id="viewForm">
    <div class="card">
      <div class="section-label">Nova AnÃ¡lise</div>

      <div class="field">
        <label for="dataCrime">Data do fato do crime atual</label>
        <input type="date" id="dataCrime" />
      </div>

      <div class="field">
        <label>CertidÃ£o de Antecedentes</label>

        <div class="dropzone" id="dropzone">
          <input type="file" id="fileInput" accept=".pdf,.txt" />
          <div class="dz-icon">ğŸ“„</div>
          <div class="dz-title">Arraste o arquivo aqui</div>
          <div class="dz-sub">ou clique para procurar Â· PDF ou TXT Â· mÃ¡x. 15 pÃ¡ginas</div>
        </div>

        <div class="file-chip hidden" id="fileChip">
          <div class="file-chip-icon">ğŸ“</div>
          <div class="file-chip-info">
            <div class="file-chip-name" id="chipName"></div>
            <div class="file-chip-size" id="chipSize"></div>
          </div>
          <button class="file-chip-remove" id="btnRemove" title="Remover arquivo">âœ•</button>
        </div>
      </div>

      <button class="btn-analyze" id="btnAnalyze" disabled>Analisar CertidÃ£o</button>

      <div class="notice notice-warn">
        <span class="notice-icon">âš ï¸</span>
        <span>Ferramenta de apoio judicial. NÃ£o substitui o juÃ­zo do magistrado. Verifique os resultados antes de utilizar em processos. Trate dados criminais conforme a LGPD.</span>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div id="viewLoading" class="card loading-wrap hidden">
    <div class="spinner"></div>
    <div class="loading-title">Analisando certidÃ£o...</div>
    <div class="loading-sub">Lendo todas as pÃ¡ginas e verificando condenaÃ§Ãµes</div>
  </div>

  <!-- RESULT -->
  <div id="viewResult" class="hidden">
    <div class="card">
      <div class="result-topbar">
        <span class="badge-ok">âœ“ AnÃ¡lise concluÃ­da</span>
        <div class="result-actions">
          <button class="btn-sm" id="btnCopy">ğŸ“‹ Copiar</button>
          <button class="btn-sm pri" id="btnNew">+ Nova anÃ¡lise</button>
        </div>
      </div>
      <div class="md" id="mdResult"></div>
    </div>
  </div>

</main>

<!-- â•â• FOOTER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer>
  <span>JusCrim-FA Â· CC BY-NC 4.0 Â· <a href="https://github.com/luishenss/JusCrim-FA" target="_blank">GitHub</a></span>
  <span>Apenas certidÃµes TJSP Â· Uso exclusivamente judicial</span>
</footer>

<!-- â•â• MODAL: LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="modalLogin">
  <div class="modal">
    <div class="modal-icon">ğŸ”‘</div>
    <h2>Acesso ao sistema</h2>
    <p class="desc">Insira suas credenciais para acessar o <strong>JusCrim-FA</strong>.<br>Sistema restrito a uso exclusivamente judicial.</p>
    <label class="modal-label">UsuÃ¡rio</label>
    <div class="input-wrap">
      <input type="text" id="loginUser" placeholder="nome de usuÃ¡rio" autocomplete="username" />
    </div>
    <label class="modal-label">Senha</label>
    <div class="input-wrap" style="margin-bottom:0">
      <input type="password" id="loginPass" placeholder="senha" autocomplete="current-password" />
      <button class="toggle-pw" data-target="loginPass">ğŸ‘</button>
    </div>
    <div id="loginError" style="font-size:.78rem;color:var(--red);margin-top:8px;margin-bottom:4px;display:none;">
      UsuÃ¡rio ou senha incorretos. Tente novamente.
    </div>
    <div class="modal-footer" style="margin-top:18px;">
      <button class="btn-sm pri" id="btnLogin">Entrar â†’</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: CONFIGURAR CHAVE API (admin) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay hidden" id="modalSetup">
  <div class="modal">
    <div class="modal-icon">ğŸ”</div>
    <h2>Configurar chave API</h2>
    <p class="desc">
      Insira sua chave da API Anthropic. Ela serÃ¡
      <strong>criptografada automaticamente</strong> antes de ser armazenada â€”
      os assistentes nÃ£o terÃ£o acesso a ela.<br><br>
      Obtenha sua chave em <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>.
    </p>
    <label class="modal-label">Chave da API Anthropic</label>
    <div class="input-wrap" style="margin-bottom:0">
      <input type="password" id="setupKey" placeholder="sk-ant-..." spellcheck="false" autocomplete="off" class="mono" />
      <button class="toggle-pw" data-target="setupKey">ğŸ‘</button>
    </div>
    <div class="modal-footer" style="margin-top:18px;">
      <button class="btn-sm pri" id="btnSetupSave">Criptografar e salvar â†’</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: CONFIGURAÃ‡Ã•ES (admin) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay hidden" id="modalSettings">
  <div class="modal">
    <div class="modal-icon">âš™ï¸</div>
    <h2>ConfiguraÃ§Ãµes</h2>
    <p class="desc">Confirme sua senha para salvar alteraÃ§Ãµes.</p>
    <label class="modal-label">Sua senha (confirmaÃ§Ã£o)</label>
    <div class="input-wrap">
      <input type="password" id="settingsAdminPass" placeholder="sua senha" autocomplete="current-password" />
      <button class="toggle-pw" data-target="settingsAdminPass">ğŸ‘</button>
    </div>
    <label class="modal-label">
      Nova chave de API
      <span class="modal-label-note">(deixe em branco para manter a atual)</span>
    </label>
    <div class="input-wrap" style="margin-bottom:0">
      <input type="password" id="settingsNewKey" placeholder="sk-ant-..." spellcheck="false" autocomplete="off" class="mono" />
      <button class="toggle-pw" data-target="settingsNewKey">ğŸ‘</button>
    </div>
    <div id="settingsError" style="font-size:.78rem;color:var(--red);margin-top:8px;display:none;"></div>
    <div class="modal-footer" style="margin-top:18px;">
      <button class="btn-sm" id="btnSettingsCancel">Cancelar</button>
      <button class="btn-sm" id="btnResetKey" style="color:var(--red);">Redefinir chave</button>
      <button class="btn-sm pri" id="btnSettingsSave">Salvar</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- â•â• SCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â”€â”€ System prompt embutido â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SYSTEM_PROMPT = `ANÃLISE DE CERTIDÃƒO DE ANTECEDENTES CRIMINAIS
FunÃ§Ã£o: Identificar maus antecedentes e reincidÃªncia criminal
VersÃ£o: 3.4
Uso: Fins exclusivamente judiciais

PERSONA: VocÃª Ã© um juiz criminal experiente com 15 anos de magistratura, especializado em direito penal e dosimetria da pena. Sua expertise inclui anÃ¡lise precisa de antecedentes criminais para aplicaÃ§Ã£o correta dos institutos de maus antecedentes e reincidÃªncia conforme o CÃ³digo Penal brasileiro.

INPUTS NECESSÃRIOS:
- Upload: CertidÃ£o de antecedentes (PDF/imagem)
- Data do crime atual: dd/mm/aaaa

LIMITAÃ‡Ã•ES:
- Apenas certidÃµes do TJSP
- Documentos em portuguÃªs
- MÃ¡ximo 15 pÃ¡ginas por anÃ¡lise

---

REGRAS TEMPORAIS FUNDAMENTAIS:

REINCIDÃŠNCIA (art. 63, CP):
- Fato anterior ao crime atual
- TrÃ¢nsito em julgado ANTERIOR ao crime atual
- ExtinÃ§Ã£o hÃ¡ menos de 5 anos OU sem extinÃ§Ã£o

MAUS ANTECEDENTES (art. 59, CP):
- Fato anterior ao crime atual
- TrÃ¢nsito em julgado (ANTERIOR OU POSTERIOR ao crime atual)
- ExtinÃ§Ã£o hÃ¡ mais de 5 anos

NENHUM DOS INSTITUTOS:
- Fato posterior ao crime atual (independente do trÃ¢nsito)

---

METODOLOGIA OBRIGATÃ“RIA - ORDEM RÃGIDA:

ETAPA 1 - LEITURA COMPLETA ANTES DE QUALQUER ANÃLISE:
- PROIBIDO: Analisar ou classificar qualquer processo antes de ler TODA a certidÃ£o
- OBRIGATÃ“RIO: Primeiro leia todas as pÃ¡ginas, depois inicie a anÃ¡lise
- CHECKPOINT: Confirme que leu todas as pÃ¡ginas antes de prosseguir
- Leia LINHA POR LINHA de todas as pÃ¡ginas antes de extrair qualquer informaÃ§Ã£o
- Mapeie TODOS os processos mencionados no documento
- CRUCIAL: Identifique pares de processos relacionados:
  - Processo de ExecuÃ§Ã£o: Aparece como "ExecuÃ§Ã£o de Pena: [nÃºmero da execuÃ§Ã£o] ([nÃºmero original])"
  - Processo Original: O nÃºmero entre parÃªnteses Ã© o processo da fase de conhecimento
  - Analise SEMPRE em conjunto - dados podem estar distribuÃ­dos entre ambos

ETAPA 2 - IDENTIFICAÃ‡ÃƒO DE CONDENAÃ‡Ã•ES VÃLIDAS:
- Procure por processos que contenham:
  - "SentenÃ§a CondenatÃ³ria" OU "AcÃ³rdÃ£o CondenatÃ³rio" OU "AcordÃ£o - SentenÃ§a"
  - E "TrÃ¢nsito em julgado para a Defesa" (com possÃ­veis variaÃ§Ãµes de maiÃºsculas/minÃºsculas)

REGRA CRÃTICA: A data do trÃ¢nsito em julgado (anterior/posterior ao crime atual) NÃƒO exclui a condenaÃ§Ã£o da anÃ¡lise - apenas define se serÃ¡ reincidÃªncia, maus antecedentes ou nenhum dos institutos.

ANALISE EXTINÃ‡Ã•ES COM CUIDADO:
- INCLUA: "ExtinÃ§Ã£o da Punibilidade" que ocorreu APÃ“S sentenÃ§a condenatÃ³ria (pode configurar maus antecedentes/reincidÃªncia)
- EXCLUA: "ExtinÃ§Ã£o da Punibilidade" que ocorreu ANTES de qualquer condenaÃ§Ã£o

IGNORE COMPLETAMENTE:
- Processos apenas com "InquÃ©rito Policial"
- "SentenÃ§a AbsolutÃ³ria"
- "SentenÃ§a de ImpronÃºncia"
- "Termo Circunstanciado" sem condenaÃ§Ã£o
- Processos sem trÃ¢nsito em julgado para a defesa

ETAPA 3 - VERIFICAÃ‡ÃƒO DUPLA ANTES DA CLASSIFICAÃ‡ÃƒO:
Antes de classificar qualquer condenaÃ§Ã£o, responda:
1. "HÃ¡ sentenÃ§a condenatÃ³ria?" (Sim/NÃ£o)
2. "HÃ¡ trÃ¢nsito em julgado para a defesa?" (Sim/NÃ£o + Data)
3. "Qual a relaÃ§Ã£o temporal com o crime atual?" (Anterior/Posterior)

Se qualquer resposta for "NÃ£o" ou "NÃ£o encontrado" â†’ EXCLUIR
Se todas forem "Sim" â†’ INCLUIR e classificar conforme data

- Para cada par processo original + execuÃ§Ã£o, extraia informaÃ§Ãµes de AMBOS
- Conecte as informaÃ§Ãµes: O mesmo caso pode ter dados espalhados entre processo original e execuÃ§Ã£o
- NÃºmeros de processo: Cite AMBOS (original e execuÃ§Ã£o) para rastreabilidade completa
- Datas crÃ­ticas: Podem estar em qualquer uma das seÃ§Ãµes - analise toda a certidÃ£o

ETAPA 4 - BUSCA SISTEMÃTICA POR TRÃ‚NSITO EM JULGADO:
- Procure por variaÃ§Ãµes: "TrÃ¢nsito em julgado para a Defesa", "TrÃ¢nsito em Julgado para a Defesa"
- A data pode estar no processo original OU na execuÃ§Ã£o
- Se nÃ£o encontrar no original, verifique na seÃ§Ã£o de execuÃ§Ã£o

---

DADOS A EXTRAIR:
Para cada condenaÃ§Ã£o vÃ¡lida (analisando processo original + execuÃ§Ã£o em conjunto):
1. Vara criminal: [onde tramitou o processo original] (pÃ¡gina X)
2. NÃºmeros dos processos: [Original: XXXX] [ExecuÃ§Ã£o: YYYY] (pÃ¡gina X)
3. Crime anterior: [transcreva EXATAMENTE como consta] (pÃ¡gina X)
4. Data do fato do crime anterior: [dd/mm/aaaa] (pÃ¡gina X)
5. Data do trÃ¢nsito em julgado PARA A DEFESA: [dd/mm/aaaa] (pÃ¡gina X)
6. Data da extinÃ§Ã£o da punibilidade: [dd/mm/aaaa OU "NÃ£o consta"] (pÃ¡gina X)
7. Data do fato do crime atual: [conforme informado pelo usuÃ¡rio]

REGRAS DE EXTRAÃ‡ÃƒO:
- Analise processo original + execuÃ§Ã£o como UM CASO
- Se nÃ£o encontrar "TrÃ¢nsito em julgado para a Defesa": NÃƒO inclua
- Para extinÃ§Ãµes: Verifique se houve condenaÃ§Ã£o anterior vÃ¡lida - se sim, INCLUA na anÃ¡lise
- InformaÃ§Ãµes distribuÃ­das: Combine dados de ambas as seÃ§Ãµes do mesmo caso
- Sempre cite ambos os nÃºmeros de processo para rastreabilidade
- Cite a pÃ¡gina onde encontrou cada informaÃ§Ã£o

---

CHECKPOINT TEMPORAL OBRIGATÃ“RIO:
Para cada condenaÃ§Ã£o vÃ¡lida, responda:
1. "Data do fato Ã© anterior ao crime atual?" (Sim/NÃ£o)
2. "Data do trÃ¢nsito Ã© anterior ao crime atual?" (Sim/NÃ£o)
3. "HÃ¡ extinÃ§Ã£o da punibilidade?" (Sim/NÃ£o + quando)

DECISÃƒO:
- Se Fato > Crime atual â†’ NENHUM DOS INSTITUTOS
- Se Fato < Crime atual E TrÃ¢nsito < Crime atual â†’ Avaliar REINCIDÃŠNCIA
- Se Fato < Crime atual E TrÃ¢nsito > Crime atual â†’ Avaliar MAUS ANTECEDENTES

---

CLASSIFICAÃ‡ÃƒO JURÃDICA:
SEMPRE CALCULE:
1. Crime atual: [data informada]
2. Fato do crime anterior: [data encontrada]
3. TrÃ¢nsito em julgado: [data encontrada]
4. ExtinÃ§Ã£o da pena: [data encontrada ou "nÃ£o consta"]

FÃ“RMULAS OBRIGATÃ“RIAS:
- REINCIDÃŠNCIA = (Fato < Crime atual) E (TrÃ¢nsito < Crime atual) E (ExtinÃ§Ã£o = "nÃ£o consta" OU ExtinÃ§Ã£o hÃ¡ menos de 5 anos)
- MAUS ANTECEDENTES = (Fato < Crime atual) E (TrÃ¢nsito pode ser anterior OU posterior) E (ExtinÃ§Ã£o hÃ¡ mais de 5 anos OU sem extinÃ§Ã£o, mas sem reincidÃªncia)
- NENHUM DOS INSTITUTOS = (Fato > Crime atual)

ATENÃ‡ÃƒO: Mesmo com extinÃ§Ã£o por indulto, se houve condenaÃ§Ã£o vÃ¡lida anterior, INCLUA na anÃ¡lise.

CÃLCULOS:
- Mostre: "Entre [data inicial] e [data final] transcorreram X anos e Y meses"
- Aplique art. 10 do CP (dia inicial incluÃ­do no cÃ´mputo)

---

FORMATO DE SAÃDA OBRIGATÃ“RIO:

### RESUMO EXECUTIVO
[3 linhas sobre o resultado da anÃ¡lise]

### TABELA RESUMO DOS RESULTADOS
| NÂº | Processo Original | Crime | Data do Fato | TrÃ¢nsito p/ Defesa | ClassificaÃ§Ã£o |
|----|-------------------|-------|--------------|-------------------|---------------|
| 1  | [nÃºmero] | [crime] | [dd/mm/aaaa] | [dd/mm/aaaa] | [ReincidÃªncia/Maus Antecedentes/Nenhum] |

### CONDENAÃ‡Ã•ES VÃLIDAS IDENTIFICADAS
[ORDENE POR ORDEM DE APARIÃ‡ÃƒO NA CERTIDÃƒO]
[N]Âª CONDENAÃ‡ÃƒO: [todas as informaÃ§Ãµes extraÃ­das]

### PROCESSOS EXCLUÃDOS DA ANÃLISE
PROCESSO EXCLUÃDO [N]:
- NÃºmero do processo: [nÃºmero] (pÃ¡gina X)
- Tipo de decisÃ£o: [tipo]
- Motivo da exclusÃ£o: [explicaÃ§Ã£o especÃ­fica]
- Data: [se disponÃ­vel]

### CLASSIFICAÃ‡ÃƒO FINAL
- Total de condenaÃ§Ãµes vÃ¡lidas: [X]
- ReincidÃªncia: [X] condenaÃ§Ã£o(Ãµes)
- Maus antecedentes: [X] condenaÃ§Ã£o(Ãµes)
- Nenhum dos institutos: [X] condenaÃ§Ã£o(Ãµes)

### RECOMENDAÃ‡Ã•ES
[OrientaÃ§Ãµes especÃ­ficas para o caso]

---

AUTO-VERIFICAÃ‡ÃƒO OBRIGATÃ“RIA â€” confirme antes de entregar:
[ ] Li TODAS as pÃ¡ginas antes de iniciar qualquer anÃ¡lise
[ ] Analisei processos originais + execuÃ§Ãµes em conjunto
[ ] Encontrei variaÃ§Ãµes de "TrÃ¢nsito em julgado para a Defesa"
[ ] Para cada INCLUÃDO: confirmei sentenÃ§a condenatÃ³ria + trÃ¢nsito em julgado
[ ] Para cada EXCLUÃDO: expliquei especificamente o motivo
[ ] Apliquei o CHECKPOINT TEMPORAL para cada condenaÃ§Ã£o
[ ] Calculei corretamente todas as datas usando art. 10 do CP
[ ] Verifiquei se extinÃ§Ãµes ocorreram APÃ“S condenaÃ§Ãµes vÃ¡lidas
[ ] Citei ambos os nÃºmeros de processo quando aplicÃ¡vel
[ ] Listei TODOS os processos (incluÃ­dos + excluÃ­dos)
[ ] Ordenei condenaÃ§Ãµes por ordem de apariÃ§Ã£o na certidÃ£o
[ ] Combinei informaÃ§Ãµes distribuÃ­das entre seÃ§Ãµes relacionadas
[ ] Criei a tabela resumo com todos os resultados

Se encontrar inconsistÃªncias ou nÃ£o conseguir conectar informaÃ§Ãµes entre processo original e execuÃ§Ã£o, PARE e solicite esclarecimento.`;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIGURAÃ‡ÃƒO DE USUÃRIOS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   admin: true  â†’ acesso Ã s configuraÃ§Ãµes (pode ver/alterar chave API)
   admin: false â†’ apenas uso da ferramenta (nunca vÃª a chave API)

   Para gerar o hash SHA-256 de uma senha, abra o console (F12) e execute:
   crypto.subtle.digest('SHA-256', new TextEncoder().encode('SUASENHA'))
     .then(b => console.log([...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,'0')).join('')))

   Credencial inicial do admin: admin / admin
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const USERS = [
  { u: 'admin', h: '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918', admin: true },
  // Assistentes (admin: false):
  { u: 'thiago',  h: '5261179a0db1b96f00ff6b9ee894360feb1ef4530fa1cc063480ee696ffb083e', admin: false },
  { u: 'rafaela', h: '0fe06d9d89cc6a86184d1b00d28cde22bdc4c043d3e3b3e05ae191be0da2140e', admin: false },
  { u: 'estag1',  h: '37301bf72eb9290d8fd0248b75426b29e0b0f81683d375fbc11d0f9ee7b8e786', admin: false },
  { u: 'estag2',  h: '5527aba3e5f7fd672f5d367d02d902f44517d6277b99a5ea0b0e85f6853e306a', admin: false },
  { u: 'desyree', h: 'fd8fc6dfc191001e8b78595c883eff1c0711a1ca6226fbc89ecf42bafec03a6c', admin: false },
];

/* â”€â”€ Estado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let currentFile = null;
let rawResult   = '';
let sessionKey  = null;  // chave API em memÃ³ria
let loggedUser  = null;  // usuÃ¡rio autenticado
let isAdmin     = false; // se o usuÃ¡rio tem papel de admin

/* â”€â”€ Crypto â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const STORAGE_KEY    = 'juscrim_enc';
// Passphrase fixa usada para criptografia automÃ¡tica da chave API.
// A chave fica protegida em localStorage (ilegÃ­vel sem este cÃ³digo),
// mas nÃ£o Ã© exibida em nenhuma interface â€” os assistentes nÃ£o tÃªm acesso.
const AUTO_PASSPHRASE = 'JsCrFa-auto-2026-k9m3';

function b64(buf) {
  return btoa(String.fromCharCode(...new Uint8Array(buf)));
}
function unb64(s) {
  return Uint8Array.from(atob(s), c => c.charCodeAt(0));
}

async function deriveKey(passphrase, salt) {
  const km = await crypto.subtle.importKey(
    'raw', new TextEncoder().encode(passphrase), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
    km,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

async function autoEncrypt(apiKey) {
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv   = crypto.getRandomValues(new Uint8Array(12));
  const key  = await deriveKey(AUTO_PASSPHRASE, salt);
  const ct   = await crypto.subtle.encrypt(
    { name: 'AES-GCM', iv }, key, new TextEncoder().encode(apiKey));
  return JSON.stringify({ c: b64(ct), i: b64(iv), s: b64(salt) });
}

async function autoDecrypt(stored) {
  const { c, i, s } = JSON.parse(stored);
  const key = await deriveKey(AUTO_PASSPHRASE, unb64(s));
  try {
    const plain = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: unb64(i) }, key, unb64(c));
    return new TextDecoder().decode(plain);
  } catch {
    throw new Error('Formato de chave incompatÃ­vel. Reconfigure.');
  }
}

async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

/* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', () => {
  setupDropzone();
  setupUI();
  show_modal('modalLogin');
  document.getElementById('loginUser').focus();
});

function show_modal(id) {
  ['modalLogin', 'modalSetup', 'modalSettings'].forEach(m =>
    document.getElementById(m).classList.toggle('hidden', m !== id));
}

function setSessionKey(key) {
  sessionKey = key;
  const b = document.getElementById('lockBadge');
  b.textContent = 'ğŸ”“ SessÃ£o ativa';
  b.className = 'lock-badge unlocked';
}

/* â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function doLogin() {
  const u     = document.getElementById('loginUser').value.trim().toLowerCase();
  const p     = document.getElementById('loginPass').value;
  const errEl = document.getElementById('loginError');
  errEl.style.display = 'none';

  if (!u || !p) { errEl.style.display = 'block'; return; }

  const btn = document.getElementById('btnLogin');
  btn.disabled = true; btn.textContent = 'Verificando...';

  try {
    const hash = await sha256(p);
    const user = USERS.find(x => x.u === u && x.h === hash);

    if (!user) {
      errEl.style.display = 'block';
      document.getElementById('loginPass').value = '';
      document.getElementById('loginPass').focus();
      btn.disabled = false; btn.textContent = 'Entrar â†’';
      return;
    }

    // Login bem-sucedido
    setLoggedUser(user.u, !!user.admin);
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';

    // Carregar chave API automaticamente
    const stored = localStorage.getItem(STORAGE_KEY);
    if (!stored) {
      if (user.admin) {
        // Admin precisa configurar a chave pela primeira vez
        show_modal('modalSetup');
      } else {
        show_modal('');
        toast('âš ï¸ Chave API nÃ£o configurada. Contate o administrador.');
      }
    } else {
      try {
        const apiKey = await autoDecrypt(stored);
        setSessionKey(apiKey);
        show_modal('');
        toast('âœ… SessÃ£o iniciada!');
      } catch (err) {
        // Chave pode estar em formato antigo (criptografada com PIN)
        show_modal('');
        if (user.admin) {
          if (confirm('Erro ao carregar a chave API. Isso pode ocorrer se ela foi configurada com o sistema anterior (PIN). Deseja reconfigurar agora?')) {
            localStorage.removeItem(STORAGE_KEY);
            show_modal('modalSetup');
          }
        } else {
          toast('âš ï¸ Erro ao carregar chave. Contate o administrador.');
        }
      }
    }
  } catch (err) {
    toast('âŒ Erro: ' + err.message);
  }
  btn.disabled = false; btn.textContent = 'Entrar â†’';
}

function setLoggedUser(name, admin) {
  loggedUser = name;
  isAdmin    = admin;
  document.getElementById('userLabel').textContent = name;
  document.getElementById('userBadge').classList.remove('hidden');
  document.getElementById('btnLogout').classList.remove('hidden');
  // BotÃ£o de configuraÃ§Ãµes: apenas admin
  document.getElementById('btnSettings').classList.toggle('hidden', !admin);
}

function doLogout() {
  if (!confirm('Deseja encerrar a sessÃ£o?')) return;
  loggedUser = null;
  sessionKey = null;
  isAdmin    = false;
  document.getElementById('userBadge').classList.add('hidden');
  document.getElementById('btnLogout').classList.add('hidden');
  document.getElementById('btnSettings').classList.add('hidden');
  const b = document.getElementById('lockBadge');
  b.textContent = 'ğŸ”’ Bloqueado';
  b.className   = 'lock-badge locked';
  show_modal('modalLogin');
  document.getElementById('loginError').style.display = 'none';
}

/* â”€â”€ UI wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setupUI() {
  // Login / logout
  document.getElementById('btnLogin').addEventListener('click', doLogin);
  document.getElementById('loginUser').addEventListener('keydown',
    e => { if (e.key === 'Enter') document.getElementById('loginPass').focus(); });
  document.getElementById('loginPass').addEventListener('keydown',
    e => { if (e.key === 'Enter') doLogin(); });
  document.getElementById('btnLogout').addEventListener('click', doLogout);

  // Main form
  document.getElementById('dataCrime').addEventListener('input', syncBtn);
  document.getElementById('btnAnalyze').addEventListener('click', runAnalysis);
  document.getElementById('btnNew').addEventListener('click', resetToForm);
  document.getElementById('btnCopy').addEventListener('click', () =>
    navigator.clipboard.writeText(rawResult).then(() => toast('âœ… Resultado copiado!')));

  // Setup (configuraÃ§Ã£o inicial da chave)
  document.getElementById('btnSetupSave').addEventListener('click', doSetup);
  document.getElementById('setupKey').addEventListener('keydown',
    e => { if (e.key === 'Enter') doSetup(); });

  // Settings
  document.getElementById('btnSettings').addEventListener('click', openSettings);
  document.getElementById('btnSettingsCancel').addEventListener('click', () =>
    document.getElementById('modalSettings').classList.add('hidden'));
  document.getElementById('btnSettingsSave').addEventListener('click', doSettingsSave);
  document.getElementById('btnResetKey').addEventListener('click', doResetKey);

  // Remove file
  document.getElementById('btnRemove').addEventListener('click', removeFile);

  // Password toggles
  document.querySelectorAll('.toggle-pw').forEach(btn =>
    btn.addEventListener('click', () => {
      const inp = document.getElementById(btn.dataset.target);
      inp.type = inp.type === 'password' ? 'text' : 'password';
      btn.textContent = inp.type === 'password' ? 'ğŸ‘' : 'ğŸ™ˆ';
    }));
}

/* â”€â”€ ConfiguraÃ§Ã£o inicial da chave API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function doSetup() {
  const apiKey = document.getElementById('setupKey').value.trim();
  if (!apiKey.startsWith('sk-')) { toast('âš ï¸ Chave invÃ¡lida â€” deve comeÃ§ar com "sk-"'); return; }

  const btn = document.getElementById('btnSetupSave');
  btn.disabled = true; btn.textContent = 'Criptografando...';
  try {
    const enc = await autoEncrypt(apiKey);
    localStorage.setItem(STORAGE_KEY, enc);
    setSessionKey(apiKey);
    show_modal('');
    toast('âœ… Chave criptografada e salva!');
    document.getElementById('setupKey').value = '';
  } catch (err) {
    toast('âŒ Erro: ' + err.message);
  }
  btn.disabled = false; btn.textContent = 'Criptografar e salvar â†’';
}

/* â”€â”€ ConfiguraÃ§Ãµes (admin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openSettings() {
  ['settingsAdminPass', 'settingsNewKey'].forEach(id =>
    document.getElementById(id).value = '');
  document.getElementById('settingsError').style.display = 'none';
  document.getElementById('modalSettings').classList.remove('hidden');
}

async function doSettingsSave() {
  const adminPass = document.getElementById('settingsAdminPass').value;
  const newKey    = document.getElementById('settingsNewKey').value.trim();
  const errEl     = document.getElementById('settingsError');
  errEl.style.display = 'none';

  const btn = document.getElementById('btnSettingsSave');
  btn.disabled = true; btn.textContent = 'Salvando...';

  try {
    // Verificar senha do admin
    const adminUser = USERS.find(x => x.u === loggedUser && x.admin);
    if (!adminUser) throw new Error('Acesso negado');

    const hash = await sha256(adminPass);
    if (hash !== adminUser.h) throw new Error('Senha incorreta');

    // Determinar a chave final
    const finalKey = newKey || sessionKey;
    if (!finalKey) throw new Error('Nenhuma chave disponÃ­vel');
    if (newKey && !newKey.startsWith('sk-')) throw new Error('Chave de API invÃ¡lida');

    const enc = await autoEncrypt(finalKey);
    localStorage.setItem(STORAGE_KEY, enc);
    setSessionKey(finalKey);
    document.getElementById('modalSettings').classList.add('hidden');
    document.getElementById('settingsAdminPass').value = '';
    document.getElementById('settingsNewKey').value = '';
    toast('âœ… ConfiguraÃ§Ãµes salvas!');
  } catch (err) {
    errEl.textContent = err.message;
    errEl.style.display = 'block';
  }
  btn.disabled = false; btn.textContent = 'Salvar';
}

async function doResetKey() {
  const adminPass = document.getElementById('settingsAdminPass').value;
  const errEl     = document.getElementById('settingsError');
  errEl.style.display = 'none';

  if (!adminPass) {
    errEl.textContent = 'Preencha a senha para confirmar a redefiniÃ§Ã£o.';
    errEl.style.display = 'block';
    return;
  }

  const adminUser = USERS.find(x => x.u === loggedUser && x.admin);
  if (!adminUser) { errEl.textContent = 'Acesso negado'; errEl.style.display = 'block'; return; }

  const hash = await sha256(adminPass);
  if (hash !== adminUser.h) {
    errEl.textContent = 'Senha incorreta';
    errEl.style.display = 'block';
    return;
  }

  if (!confirm('Remover a chave API salva? SerÃ¡ necessÃ¡rio configurar novamente.')) return;

  localStorage.removeItem(STORAGE_KEY);
  sessionKey = null;
  const b = document.getElementById('lockBadge');
  b.textContent = 'ğŸ”’ Sem chave';
  b.className = 'lock-badge locked';
  document.getElementById('modalSettings').classList.add('hidden');
  show_modal('modalSetup');
  toast('ğŸ—‘ï¸ Chave removida. Configure novamente.');
}

/* â”€â”€ Dropzone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setupDropzone() {
  const dz = document.getElementById('dropzone');
  const fi = document.getElementById('fileInput');

  dz.addEventListener('dragover',  e => { e.preventDefault(); dz.classList.add('drag-over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
  dz.addEventListener('drop', e => {
    e.preventDefault();
    dz.classList.remove('drag-over');
    if (e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]);
  });
  fi.addEventListener('change', () => { if (fi.files[0]) setFile(fi.files[0]); });
}

function setFile(file) {
  const ok = file.type === 'application/pdf' || file.name.endsWith('.pdf') || file.name.endsWith('.txt');
  if (!ok)                           { toast('âš ï¸ Use PDF ou TXT'); return; }
  if (file.size > 30 * 1024 * 1024) { toast('âš ï¸ Arquivo muito grande (mÃ¡x. 30 MB)'); return; }

  currentFile = file;
  document.getElementById('dropzone').classList.add('hidden');
  document.getElementById('fileChip').classList.remove('hidden');
  document.getElementById('chipName').textContent = file.name;
  document.getElementById('chipSize').textContent = fmtBytes(file.size);
  syncBtn();
}

function removeFile() {
  currentFile = null;
  document.getElementById('fileInput').value = '';
  document.getElementById('fileChip').classList.add('hidden');
  document.getElementById('dropzone').classList.remove('hidden');
  syncBtn();
}

function syncBtn() {
  const ok = !!document.getElementById('dataCrime').value && !!currentFile;
  document.getElementById('btnAnalyze').disabled = !ok;
}

function fmtBytes(b) {
  if (b < 1024)       return b + ' B';
  if (b < 1024 * 1024) return (b / 1024).toFixed(1) + ' KB';
  return (b / (1024 * 1024)).toFixed(1) + ' MB';
}

/* â”€â”€ Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function runAnalysis() {
  const key = sessionKey;
  if (!key) { toast('âš ï¸ SessÃ£o sem chave API. Contate o administrador.'); return; }

  const isoDate = document.getElementById('dataCrime').value;
  const [y, m, d] = isoDate.split('-');
  const date = `${d}/${m}/${y}`;

  show('viewLoading');

  try {
    let content;

    if (currentFile.type === 'application/pdf' || currentFile.name.endsWith('.pdf')) {
      const b64data = await toBase64(currentFile);
      content = [
        { type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: b64data } },
        { type: 'text', text: `Data do fato do crime atual: ${date}` }
      ];
    } else {
      const txt = await toText(currentFile);
      content = [{ type: 'text', text: `Data do fato do crime atual: ${date}\n\nCertidÃ£o de Antecedentes:\n\n${txt}` }];
    }

    rawResult = '';
    show('viewResult');
    document.getElementById('mdResult').innerHTML = '<span class="cursor"></span>';

    await stream(key, content);

  } catch (err) {
    show('viewForm');
    toast('âŒ Erro: ' + err.message);
  }
}

async function stream(apiKey, content) {
  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-6',
      max_tokens: 8192,
      stream: true,
      system: SYSTEM_PROMPT,
      messages: [{ role: 'user', content }]
    })
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error?.message || `HTTP ${res.status}`);
  }

  const reader  = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';
  let renderPending = false;

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop();

    for (const line of lines) {
      if (!line.startsWith('data: ')) continue;
      const data = line.slice(6).trim();
      if (!data || data === '[DONE]') continue;
      try {
        const ev = JSON.parse(data);
        if (ev.type === 'content_block_delta' && ev.delta?.type === 'text_delta') {
          rawResult += ev.delta.text;
          if (!renderPending) {
            renderPending = true;
            requestAnimationFrame(() => {
              renderPending = false;
              document.getElementById('mdResult').innerHTML =
                marked.parse(rawResult) + '<span class="cursor"></span>';
            });
          }
        }
      } catch {}
    }
  }

  // Final render â€” no cursor
  document.getElementById('mdResult').innerHTML = marked.parse(rawResult);
}

/* â”€â”€ View helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function show(id) {
  ['viewForm', 'viewLoading', 'viewResult'].forEach(v =>
    document.getElementById(v).classList.toggle('hidden', v !== id));
}

function resetToForm() {
  rawResult = '';
  removeFile();
  document.getElementById('dataCrime').value = '';
  syncBtn();
  show('viewForm');
}

/* â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toBase64(file) {
  return new Promise((ok, err) => {
    const r = new FileReader();
    r.onload  = e => ok(e.target.result.split(',')[1]);
    r.onerror = err;
    r.readAsDataURL(file);
  });
}

function toText(file) {
  return new Promise((ok, err) => {
    const r = new FileReader();
    r.onload  = e => ok(e.target.result);
    r.onerror = err;
    r.readAsText(file, 'utf-8');
  });
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}
</script>
</body>
</html>
