<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JusCrim-FA ‚Äî An√°lise de Antecedentes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    :root {
      --bg:          #f1f5f9;
      --surface:     #ffffff;
      --surface-2:   #f8fafc;
      --border:      #e2e8f0;
      --primary:     #4f46e5;
      --primary-h:   #4338ca;
      --primary-bg:  #eef2ff;
      --text:        #0f172a;
      --text-2:      #475569;
      --text-3:      #94a3b8;
      --green:       #059669;
      --green-bg:    #ecfdf5;
      --green-bdr:   #a7f3d0;
      --amber:       #b45309;
      --amber-bg:    #fffbeb;
      --red:         #dc2626;
      --radius:      12px;
      --shadow:      0 1px 3px rgba(0,0,0,.07), 0 1px 2px rgba(0,0,0,.04);
      --shadow-lg:   0 10px 25px -5px rgba(0,0,0,.1), 0 4px 6px -4px rgba(0,0,0,.04);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 40px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
      box-shadow: var(--shadow);
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand-icon {
      width: 38px; height: 38px;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-size: 19px;
      box-shadow: 0 2px 8px rgba(79,70,229,.3);
    }
    .brand-name { font-size: 1rem; font-weight: 800; letter-spacing: -.01em; }
    .brand-sub  { font-size: 0.68rem; color: var(--text-3); margin-top: 1px; }
    .pills { display: flex; gap: 6px; align-items: center; }
    .pill {
      font-size: 0.68rem; font-weight: 700; padding: 3px 9px;
      border-radius: 20px; letter-spacing: .02em;
    }
    .pill-blue { background: var(--primary-bg); color: var(--primary); }
    .pill-red  { background: #fef2f2; color: var(--red); }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    main {
      max-width: 660px;
      margin: 0 auto;
      padding: 40px 24px 100px;
    }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }
    .card-label {
      font-size: 0.67rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: .08em; color: var(--text-3); margin-bottom: 20px;
    }

    /* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
    .field { margin-bottom: 20px; }
    .field label {
      display: block; font-size: 0.82rem; font-weight: 600;
      color: var(--text-2); margin-bottom: 7px;
    }
    input[type="date"] {
      width: 100%; padding: 10px 14px;
      border: 1.5px solid var(--border); border-radius: 8px;
      font-size: 0.92rem; color: var(--text); background: var(--surface);
      outline: none; font-family: inherit;
      transition: border-color .15s, box-shadow .15s;
    }
    input[type="date"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79,70,229,.1);
    }

    /* ‚îÄ‚îÄ DROPZONE ‚îÄ‚îÄ */
    .dropzone {
      border: 2px dashed var(--border); border-radius: var(--radius);
      padding: 36px 24px; text-align: center; cursor: pointer;
      transition: all .2s; position: relative; background: var(--surface-2);
    }
    .dropzone:hover, .dropzone.over {
      border-color: var(--primary); background: var(--primary-bg);
    }
    .dropzone input[type="file"] {
      position: absolute; inset: 0; opacity: 0;
      cursor: pointer; width: 100%; height: 100%; z-index: 1;
    }
    .dz-icon  { font-size: 2rem; margin-bottom: 10px; }
    .dz-title { font-size: 0.88rem; font-weight: 600; color: var(--text); margin-bottom: 4px; }
    .dz-sub   { font-size: 0.75rem; color: var(--text-3); }

    /* ‚îÄ‚îÄ FILE CHIP ‚îÄ‚îÄ */
    .file-chip {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 14px;
      background: var(--green-bg); border: 1.5px solid var(--green-bdr); border-radius: 8px;
    }
    .fc-icon { font-size: 1.3rem; flex-shrink: 0; }
    .fc-info { flex: 1; min-width: 0; }
    .fc-name { font-size: 0.82rem; font-weight: 600; color: #065f46; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .fc-size { font-size: 0.72rem; color: var(--green); margin-top: 1px; }
    .fc-rm   { background: none; border: none; color: var(--green); cursor: pointer; font-size: 1rem; padding: 4px; border-radius: 4px; transition: color .15s; }
    .fc-rm:hover { color: var(--red); }

    /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
    .progress-bar-wrap {
      height: 4px; background: var(--border); border-radius: 2px; margin-top: 12px; overflow: hidden;
    }
    .progress-bar {
      height: 100%; background: linear-gradient(90deg, #4f46e5, #7c3aed);
      border-radius: 2px; width: 0%; transition: width .3s;
    }
    .progress-label { font-size: 0.75rem; color: var(--text-3); margin-top: 6px; text-align: center; }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn-primary {
      width: 100%; padding: 13px; margin-top: 8px;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: #fff; border: none; border-radius: 10px;
      font-size: 0.92rem; font-weight: 700; cursor: pointer;
      transition: all .2s; font-family: inherit;
      box-shadow: 0 4px 14px rgba(79,70,229,.28);
      letter-spacing: .01em;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(79,70,229,.36);
    }
    .btn-primary:disabled { opacity: .4; cursor: not-allowed; box-shadow: none; }

    .btn-row { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }

    .btn {
      flex: 1; padding: 11px 16px;
      border: 1.5px solid var(--border); border-radius: 9px;
      background: var(--surface); color: var(--text-2);
      font-size: 0.82rem; font-weight: 700; cursor: pointer;
      transition: all .15s; font-family: inherit;
      display: flex; align-items: center; justify-content: center; gap: 7px;
    }
    .btn:hover { background: var(--surface-2); color: var(--text); border-color: #c7d2e0; }
    .btn.green {
      background: var(--green-bg); border-color: var(--green-bdr);
      color: #065f46;
    }
    .btn.green:hover { background: #d1fae5; }
    .btn.indigo {
      background: var(--primary); border-color: var(--primary); color: #fff;
    }
    .btn.indigo:hover { background: var(--primary-h); border-color: var(--primary-h); }

    .btn-sm {
      padding: 7px 14px; border: 1.5px solid var(--border); border-radius: 7px;
      background: var(--surface); color: var(--text-2);
      font-size: 0.78rem; font-weight: 600; cursor: pointer;
      transition: all .15s; display: flex; align-items: center; gap: 6px;
      font-family: inherit;
    }
    .btn-sm:hover { background: var(--surface-2); color: var(--text); }
    .btn-sm.pri { background: var(--primary); border-color: var(--primary); color: #fff; }
    .btn-sm.pri:hover { background: var(--primary-h); }

    /* ‚îÄ‚îÄ NOTICE ‚îÄ‚îÄ */
    .notice {
      display: flex; gap: 9px; align-items: flex-start;
      padding: 11px 14px; border-radius: 8px;
      font-size: 0.77rem; line-height: 1.55; margin-top: 16px;
    }
    .notice-warn { background: var(--amber-bg); color: var(--amber); border: 1px solid #fcd34d; }

    /* ‚îÄ‚îÄ RESULT HEADER ‚îÄ‚îÄ */
    .result-bar {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 18px; flex-wrap: wrap; gap: 10px;
    }
    .badge-ok {
      display: flex; align-items: center; gap: 6px;
      background: var(--green-bg); color: var(--green);
      border: 1px solid var(--green-bdr);
      font-size: 0.72rem; font-weight: 700; padding: 4px 12px; border-radius: 20px;
    }

    /* ‚îÄ‚îÄ PREVIEW BOX ‚îÄ‚îÄ */
    .preview-box {
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: 8px; padding: 16px;
      font-family: 'Courier New', monospace; font-size: 0.77rem;
      color: var(--text-2); line-height: 1.65;
      max-height: 320px; overflow-y: auto;
      white-space: pre-wrap; word-break: break-word;
      margin-bottom: 14px;
    }
    .preview-box::-webkit-scrollbar { width: 5px; }
    .preview-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .stat-row {
      display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;
    }
    .stat {
      flex: 1; min-width: 120px;
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px 14px; text-align: center;
    }
    .stat-val { font-size: 1.4rem; font-weight: 800; color: var(--primary); }
    .stat-lbl { font-size: 0.7rem; color: var(--text-3); margin-top: 2px; }

    /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
    footer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--surface); border-top: 1px solid var(--border);
      padding: 10px 40px; font-size: 0.7rem; color: var(--text-3);
      display: flex; justify-content: space-between; align-items: center;
    }
    footer a { color: var(--text-3); text-decoration: none; }
    footer a:hover { color: var(--text-2); }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast {
      position: fixed; bottom: 60px; right: 24px; z-index: 999;
      background: #0f172a; color: #e2e8f0;
      padding: 10px 18px; border-radius: 8px;
      font-size: 0.82rem; font-weight: 600;
      box-shadow: var(--shadow-lg);
      opacity: 0; transform: translateY(8px);
      transition: all .25s; pointer-events: none;
    }
    #toast.show { opacity: 1; transform: translateY(0); }

    .hidden { display: none !important; }

    @media (max-width: 600px) {
      main   { padding: 24px 16px 90px; }
      header { padding: 0 20px; }
      footer { padding: 10px 20px; font-size: 0.65rem; }
      .btn-row { flex-direction: column; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="brand">
    <div class="brand-icon">‚öñÔ∏è</div>
    <div>
      <div class="brand-name">JusCrim-FA</div>
      <div class="brand-sub">An√°lise de Antecedentes Criminais ¬∑ TJSP</div>
    </div>
  </div>
  <div class="pills">
    <span class="pill pill-blue">v3.4</span>
    <span class="pill pill-red">Uso Judicial</span>
  </div>
</header>

<!-- MAIN -->
<main>

  <!-- VIEW: FORMUL√ÅRIO -->
  <div id="viewForm">
    <div class="card">
      <div class="card-label">Nova An√°lise</div>

      <div class="field">
        <label for="dataCrime">Data do fato do crime atual</label>
        <input type="date" id="dataCrime" />
      </div>

      <div class="field">
        <label>Certid√£o de Antecedentes</label>
        <div class="dropzone" id="dropzone">
          <input type="file" id="fileInput" accept=".pdf,.txt" />
          <div class="dz-icon">üìÑ</div>
          <div class="dz-title">Arraste o arquivo aqui</div>
          <div class="dz-sub">ou clique para procurar ¬∑ PDF ou TXT</div>
        </div>

        <div class="file-chip hidden" id="fileChip">
          <div class="fc-icon">üìé</div>
          <div class="fc-info">
            <div class="fc-name" id="chipName"></div>
            <div class="fc-size" id="chipSize"></div>
          </div>
          <button class="fc-rm" id="btnRemove" title="Remover">‚úï</button>
        </div>

        <div class="hidden" id="extracting">
          <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar"></div></div>
          <div class="progress-label" id="progressLabel">Lendo PDF...</div>
        </div>
      </div>

      <button class="btn-primary" id="btnPrepare" disabled>Preparar An√°lise</button>

      <div class="notice notice-warn">
        <span>‚ö†Ô∏è</span>
        <span>Ferramenta de apoio judicial. N√£o substitui o ju√≠zo do magistrado. Verifique os resultados antes de utilizar em processos. Observe a LGPD ao tratar dados criminais.</span>
      </div>
    </div>
  </div>

  <!-- VIEW: PRONTO PARA ENVIAR -->
  <div id="viewReady" class="hidden">
    <div class="card">
      <div class="result-bar">
        <span class="badge-ok">‚úì An√°lise preparada</span>
        <button class="btn-sm" id="btnReset">‚Üê Nova an√°lise</button>
      </div>

      <div class="stat-row">
        <div class="stat">
          <div class="stat-val" id="statPages">‚Äî</div>
          <div class="stat-lbl">P√°ginas</div>
        </div>
        <div class="stat">
          <div class="stat-val" id="statChars">‚Äî</div>
          <div class="stat-lbl">Caracteres extra√≠dos</div>
        </div>
        <div class="stat">
          <div class="stat-val" id="statDate">‚Äî</div>
          <div class="stat-lbl">Data do crime</div>
        </div>
      </div>

      <div style="font-size:.8rem; font-weight:600; color:var(--text-2); margin-bottom:8px;">
        Pr√©-visualiza√ß√£o da mensagem
      </div>
      <div class="preview-box" id="previewBox"></div>

      <div class="btn-row">
        <button class="btn green" id="btnCopy">üìã Copiar mensagem</button>
        <button class="btn indigo" id="btnClaude">Abrir Claude.ai ‚Üó</button>
      </div>

      <div class="notice notice-warn" style="margin-top:12px;">
        <span>üí°</span>
        <span>Copie a mensagem acima, abra o Claude.ai, cole e envie. A an√°lise completa ser√° gerada automaticamente.</span>
      </div>
    </div>
  </div>

</main>

<footer>
  <span>JusCrim-FA ¬∑ CC BY-NC 4.0 ¬∑ <a href="https://github.com/luishenss/JusCrim-FA" target="_blank">GitHub</a></span>
  <span>Apenas certid√µes TJSP ¬∑ Uso exclusivamente judicial</span>
</footer>

<div id="toast"></div>

<script>
/* ‚îÄ‚îÄ Prompt embutido ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const SYSTEM_PROMPT = `Voc√™ √© um juiz criminal experiente com 15 anos de magistratura, especializado em direito penal e dosimetria da pena. Analise a certid√£o de antecedentes criminais abaixo e classifique cada condena√ß√£o conforme os institutos do C√≥digo Penal brasileiro.

REGRAS TEMPORAIS FUNDAMENTAIS:

REINCID√äNCIA (art. 63, CP):
- Fato anterior ao crime atual
- Tr√¢nsito em julgado ANTERIOR ao crime atual
- Extin√ß√£o h√° menos de 5 anos OU sem extin√ß√£o

MAUS ANTECEDENTES (art. 59, CP):
- Fato anterior ao crime atual
- Tr√¢nsito em julgado (ANTERIOR OU POSTERIOR ao crime atual)
- Extin√ß√£o h√° mais de 5 anos

NENHUM DOS INSTITUTOS:
- Fato posterior ao crime atual (independente do tr√¢nsito)

---

METODOLOGIA OBRIGAT√ìRIA - ORDEM R√çGIDA:

ETAPA 1 - LEITURA COMPLETA ANTES DE QUALQUER AN√ÅLISE:
- PROIBIDO: Analisar ou classificar qualquer processo antes de ler TODA a certid√£o
- OBRIGAT√ìRIO: Primeiro leia todas as p√°ginas, depois inicie a an√°lise
- Leia LINHA POR LINHA de todas as p√°ginas antes de extrair qualquer informa√ß√£o
- Mapeie TODOS os processos mencionados no documento
- CRUCIAL: Identifique pares de processos relacionados:
  - Processo de Execu√ß√£o: Aparece como "Execu√ß√£o de Pena: [n√∫mero da execu√ß√£o] ([n√∫mero original])"
  - Processo Original: O n√∫mero entre par√™nteses √© o processo da fase de conhecimento
  - Analise SEMPRE em conjunto - dados podem estar distribu√≠dos entre ambos

ETAPA 2 - IDENTIFICA√á√ÉO DE CONDENA√á√ïES V√ÅLIDAS:
- Procure por processos que contenham:
  - "Senten√ßa Condenat√≥ria" OU "Ac√≥rd√£o Condenat√≥rio" OU "Acord√£o - Senten√ßa"
  - E "Tr√¢nsito em julgado para a Defesa" (com poss√≠veis varia√ß√µes)
- ANALISE EXTIN√á√ïES COM CUIDADO:
  - INCLUA: "Extin√ß√£o da Punibilidade" que ocorreu AP√ìS senten√ßa condenat√≥ria
  - EXCLUA: "Extin√ß√£o da Punibilidade" que ocorreu ANTES de qualquer condena√ß√£o
- IGNORE COMPLETAMENTE: Inqu√©ritos, absolvi√ß√µes, impron√∫ncias, TCO sem condena√ß√£o, processos sem tr√¢nsito

ETAPA 3 - VERIFICA√á√ÉO DUPLA ANTES DA CLASSIFICA√á√ÉO:
Para cada condena√ß√£o, confirme:
1. H√° senten√ßa condenat√≥ria? (Sim/N√£o)
2. H√° tr√¢nsito em julgado para a defesa? (Sim/N√£o + Data)
3. Qual a rela√ß√£o temporal com o crime atual? (Anterior/Posterior)
Se qualquer resposta for "N√£o" ‚Üí EXCLUIR

ETAPA 4 - BUSCA SISTEM√ÅTICA POR TR√ÇNSITO EM JULGADO:
- Procure varia√ß√µes: "Tr√¢nsito em julgado para a Defesa", "Tr√¢nsito em Julgado para a Defesa"
- A data pode estar no processo original OU na execu√ß√£o

---

DADOS A EXTRAIR para cada condena√ß√£o v√°lida:
1. Vara criminal (p√°gina X)
2. N√∫meros dos processos: Original + Execu√ß√£o (p√°gina X)
3. Crime anterior ‚Äî transcreva EXATAMENTE como consta (p√°gina X)
4. Data do fato do crime anterior: dd/mm/aaaa (p√°gina X)
5. Data do tr√¢nsito em julgado PARA A DEFESA: dd/mm/aaaa (p√°gina X)
6. Data da extin√ß√£o da punibilidade: dd/mm/aaaa OU "N√£o consta" (p√°gina X)
7. Data do fato do crime atual: conforme informado

F√ìRMULAS OBRIGAT√ìRIAS:
- REINCID√äNCIA = (Fato < Crime atual) E (Tr√¢nsito < Crime atual) E (Extin√ß√£o = "n√£o consta" OU < 5 anos)
- MAUS ANTECEDENTES = (Fato < Crime atual) E (Tr√¢nsito anterior OU posterior) E (Extin√ß√£o > 5 anos OU sem extin√ß√£o, sem reincid√™ncia)
- NENHUM DOS INSTITUTOS = (Fato > Crime atual)

C√ÅLCULOS: Mostre "Entre [data] e [data] transcorreram X anos e Y meses" ‚Äî aplique art. 10 do CP.

---

FORMATO DE SA√çDA OBRIGAT√ìRIO:

### RESUMO EXECUTIVO
[3 linhas sobre o resultado]

### TABELA RESUMO DOS RESULTADOS
| N¬∫ | Processo Original | Crime | Data do Fato | Tr√¢nsito p/ Defesa | Classifica√ß√£o |
|----|-------------------|-------|--------------|-------------------|---------------|
| 1  | [n√∫mero] | [crime] | [dd/mm/aaaa] | [dd/mm/aaaa] | [Classifica√ß√£o] |

### CONDENA√á√ïES V√ÅLIDAS IDENTIFICADAS
[Ordene por apari√ß√£o na certid√£o]
[N]¬™ CONDENA√á√ÉO: [todas as informa√ß√µes]

### PROCESSOS EXCLU√çDOS DA AN√ÅLISE
PROCESSO EXCLU√çDO [N]:
- N√∫mero: [n√∫mero] (p√°gina X)
- Tipo de decis√£o: [tipo]
- Motivo da exclus√£o: [explica√ß√£o]

### CLASSIFICA√á√ÉO FINAL
- Total de condena√ß√µes v√°lidas: [X]
- Reincid√™ncia: [X] condena√ß√£o(√µes)
- Maus antecedentes: [X] condena√ß√£o(√µes)
- Nenhum dos institutos: [X] condena√ß√£o(√µes)

### RECOMENDA√á√ïES
[Orienta√ß√µes espec√≠ficas]

---
AUTO-VERIFICA√á√ÉO: confirme que leu TODAS as p√°ginas, analisou pares original+execu√ß√£o, verificou TODOS os processos (inclu√≠dos e exclu√≠dos), aplicou checkpoints temporais e criou a tabela resumo.

Se encontrar inconsist√™ncias, PARE e solicite esclarecimento.`;

/* ‚îÄ‚îÄ PDF.js setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let currentFile   = null;
let extractedText = '';
let pageCount     = 0;

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', () => {
  setupDropzone();

  document.getElementById('dataCrime').addEventListener('input', syncBtn);
  document.getElementById('btnPrepare').addEventListener('click', prepare);
  document.getElementById('btnRemove').addEventListener('click', removeFile);
  document.getElementById('btnReset').addEventListener('click', reset);
  document.getElementById('btnCopy').addEventListener('click', copyMsg);
  document.getElementById('btnClaude').addEventListener('click', () =>
    window.open('https://claude.ai', '_blank'));
});

/* ‚îÄ‚îÄ Dropzone ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function setupDropzone() {
  const dz = document.getElementById('dropzone');
  const fi = document.getElementById('fileInput');

  dz.addEventListener('dragover',  e => { e.preventDefault(); dz.classList.add('over'); });
  dz.addEventListener('dragleave', ()  => dz.classList.remove('over'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('over');
    if (e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]);
  });
  fi.addEventListener('change', () => { if (fi.files[0]) setFile(fi.files[0]); });
}

function setFile(file) {
  const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
  const isTXT = file.name.toLowerCase().endsWith('.txt');
  if (!isPDF && !isTXT) { toast('‚ö†Ô∏è Use PDF ou TXT'); return; }
  if (file.size > 50 * 1024 * 1024) { toast('‚ö†Ô∏è Arquivo muito grande (m√°x. 50 MB)'); return; }

  currentFile = file;
  extractedText = '';
  pageCount = 0;

  document.getElementById('dropzone').classList.add('hidden');
  document.getElementById('fileChip').classList.remove('hidden');
  document.getElementById('chipName').textContent = file.name;
  document.getElementById('chipSize').textContent = fmtBytes(file.size);
  syncBtn();
}

function removeFile() {
  currentFile = null; extractedText = '';
  document.getElementById('fileInput').value = '';
  document.getElementById('fileChip').classList.add('hidden');
  document.getElementById('dropzone').classList.remove('hidden');
  document.getElementById('extracting').classList.add('hidden');
  syncBtn();
}

function syncBtn() {
  const ok = !!document.getElementById('dataCrime').value && !!currentFile;
  document.getElementById('btnPrepare').disabled = !ok;
}

/* ‚îÄ‚îÄ Prepare ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function prepare() {
  document.getElementById('btnPrepare').disabled = true;

  const isoDate  = document.getElementById('dataCrime').value;
  const [y, m, d] = isoDate.split('-');
  const dateStr  = `${d}/${m}/${y}`;

  try {
    if (currentFile.name.toLowerCase().endsWith('.txt')) {
      extractedText = await readText(currentFile);
      pageCount = Math.ceil(extractedText.length / 3000);
    } else {
      await extractPDF(currentFile);
    }
  } catch (err) {
    toast('‚ùå Erro ao ler arquivo: ' + err.message);
    document.getElementById('btnPrepare').disabled = false;
    return;
  }

  // Build full message
  const msg = buildMessage(dateStr);

  // Stats
  document.getElementById('statPages').textContent = pageCount;
  document.getElementById('statChars').textContent = fmtNum(extractedText.length);
  document.getElementById('statDate').textContent  = dateStr;

  // Preview (first 1200 chars)
  const preview = msg.length > 1200 ? msg.slice(0, 1200) + '\n\n[... mensagem continua ...]' : msg;
  document.getElementById('previewBox').textContent = preview;

  // Switch view
  document.getElementById('viewForm').classList.add('hidden');
  document.getElementById('viewReady').classList.remove('hidden');
  document.getElementById('extracting').classList.add('hidden');
}

function buildMessage(dateStr) {
  return `${SYSTEM_PROMPT}

---

Data do fato do crime atual: ${dateStr}

CERTID√ÉO DE ANTECEDENTES CRIMINAIS:

${extractedText}`;
}

/* ‚îÄ‚îÄ PDF extraction ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function extractPDF(file) {
  document.getElementById('extracting').classList.remove('hidden');
  setProgress(0, 'Carregando PDF...');

  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  pageCount = pdf.numPages;

  let fullText = '';

  for (let i = 1; i <= pageCount; i++) {
    setProgress(Math.round((i / pageCount) * 100), `Lendo p√°gina ${i} de ${pageCount}...`);
    const page    = await pdf.getPage(i);
    const content = await page.getTextContent();
    const pageText = content.items.map(item => item.str).join(' ');
    fullText += `--- P√°gina ${i} ---\n${pageText}\n\n`;
  }

  extractedText = fullText.trim();
  setProgress(100, 'Extra√ß√£o conclu√≠da!');
}

function setProgress(pct, label) {
  document.getElementById('progressBar').style.width  = pct + '%';
  document.getElementById('progressLabel').textContent = label;
}

/* ‚îÄ‚îÄ Copy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function copyMsg() {
  const isoDate  = document.getElementById('dataCrime').value;
  const [y, m, d] = isoDate.split('-');
  const msg = buildMessage(`${d}/${m}/${y}`);
  navigator.clipboard.writeText(msg)
    .then(() => toast('‚úÖ Mensagem copiada! Cole no Claude.ai.'))
    .catch(() => toast('‚ùå Erro ao copiar ‚Äî tente selecionar e copiar manualmente.'));
}

/* ‚îÄ‚îÄ Reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function reset() {
  currentFile = null; extractedText = '';
  document.getElementById('fileInput').value = '';
  document.getElementById('dataCrime').value = '';
  document.getElementById('fileChip').classList.add('hidden');
  document.getElementById('dropzone').classList.remove('hidden');
  document.getElementById('extracting').classList.add('hidden');
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('viewReady').classList.add('hidden');
  document.getElementById('viewForm').classList.remove('hidden');
  syncBtn();
}

/* ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function readText(file) {
  return new Promise((ok, err) => {
    const r = new FileReader();
    r.onload  = e => ok(e.target.result);
    r.onerror = err;
    r.readAsText(file, 'utf-8');
  });
}

function fmtBytes(b) {
  if (b < 1024)      return b + ' B';
  if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
  return (b/(1024*1024)).toFixed(1) + ' MB';
}

function fmtNum(n) {
  return n.toLocaleString('pt-BR');
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
